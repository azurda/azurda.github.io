<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<style type=text/css>body{font-family:monospace;}</style>
	<title>Searchpathw Hook Frida</title>
	
	
	<link rel="stylesheet" href="/css/style.css">
	
	
</head>
<body>
	<header>
	===================<br>
	== <a href="https://azurda.github.io">azurda&#39;s blog</a> ==<br>
	===================
	<div style="float: right;">Blog about reverse engineering, game hacking and frida.</div><br>
	<p>
	<nav>
			<a href="/"><b>Start</b></a>.
			
			
			<a href="/posts/"><b>Posts</b></a>.
			
			<a href="/categories/"><b>Categories</b></a>.
			
			<a href="/tags/"><b>Tags</b></a>.
			
	</nav>
	</p>
	
</header>

	
	<main>
		<article>
			<h1>Searchpathw Hook Frida</h1>
			<b><time>49.20.16165 14:49</time></b>
		       

			<div>
				<p><strong>Note</strong>: *This is a quick blog post to answer the issue of an user from the FRIDA IRC / telegram channel. *</p>
<p>In this case what we want to do is to hook the SearchPathW WINAPI:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">DWORD <span style="color:#a6e22e">SearchPathW</span>(
  LPCWSTR lpPath,
  LPCWSTR lpFileName,
  LPCWSTR lpExtension,
  DWORD   nBufferLength,
  LPWSTR  lpBuffer,
  LPWSTR  <span style="color:#f92672">*</span>lpFilePart
);
</code></pre></div><p>In this case, we want to obtain the most meaningful argument which is in this case the second one, lpFileName. It is possible to extract information from the remaining fields if wanted.</p>
<p>An example program:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">
<span style="color:#75715e">// searchPathCpp.cpp : This file contains the &#39;main&#39; function. Program execution begins and ends there.
</span><span style="color:#75715e">//
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Windows.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
{
    TCHAR lpBuffer[MAX_PATH];
    LPWSTR <span style="color:#f92672">*</span>lpFilePart{};
    DWORD result;

    result <span style="color:#f92672">=</span> SearchPath(NULL, <span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;c:</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">windows</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&#34;</span>, NULL, MAX_PATH, lpBuffer, lpFilePart);
    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;SearchPath retval: &#34;</span> <span style="color:#f92672">&lt;&lt;</span> result;
}
</code></pre></div><p>We just try to check that the c:/windows path exists. Compile it and lets attach to it:</p>
<p><code>frida -f searchPathCpp.exe</code></p>
<p>
<figure>
  <img src="https://i.imgur.com/JjXHmAn.png" alt="SearchPathW output" />
</figure>


</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">[Local::searchPathCpp.exe]-&gt; searchPathPtr = Module.getExportByName(<span style="color:#e6db74">&#34;KERNELBASE.DLL&#34;</span>, <span style="color:#e6db74">&#34;SearchPathW&#34;</span>)
<span style="color:#e6db74">&#34;0x76fc02f0&#34;</span>
[Local::searchPathCpp.exe]-&gt; Interceptor.attach(searchPathPtr, { onEnter<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#66d9ef">function</span> (args) { console.log(args[1].readUtf
16String()); } })
{}
[Local::searchPathCpp.exe]-&gt; <span style="color:#66d9ef">%</span>resume
</code></pre></div><p>Step by step:</p>
<ol>
<li>Extract the pointer to KERNELBASE.DLL!SearchPathW</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">[Local::searchPathCpp.exe]-&gt; searchPathPtr = Module.getExportByName(<span style="color:#e6db74">&#34;KERNELBASE.DLL&#34;</span>, <span style="color:#e6db74">&#34;SearchPathW&#34;</span>)
<span style="color:#e6db74">&#34;0x76fc02f0&#34;</span>
</code></pre></div><ol start="2">
<li>Write an Interceptor onEnter hook</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">
<span style="color:#a6e22e">Interceptor</span>.<span style="color:#a6e22e">attach</span>(<span style="color:#a6e22e">searchPathPtr</span>, 
    { 
        <span style="color:#a6e22e">onEnter</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">args</span>) 
            { 
                <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">1</span>].<span style="color:#a6e22e">readUtf16String</span>()); 
            } 
    });
</code></pre></div><ol start="3">
<li>%resume the app, resulting in the following output</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">
[Local::searchPathCpp.exe]-&gt; <span style="color:#66d9ef">%</span>resume
SearchPath retval<span style="color:#960050;background-color:#1e0010">:</span> 11c<span style="color:#960050;background-color:#1e0010">:</span>\windows\
</code></pre></div><p>And that&rsquo;s it, if you have more questions contact me on Twitter @entdark_</p>

			</div>
		</article>
	</main>
<aside>
	<div>
		<div>
			<h3>LATEST POSTS</h3>
		</div>
		<div>
			<ul>
				
				<li><a href="/posts/reading-std-string-c&#43;&#43;/">Reading std::string C&#43;&#43;</a></li>
				
				<li><a href="/posts/proxy-quake-vm-syscalls-frida/">Proxy Quake Vm Syscalls Frida</a></li>
				
				<li><a href="/posts/objective-c-hooking/">Objective C Hooking with FRIDA</a></li>
				
				<li><a href="/posts/searchpathw-hook-frida/">Searchpathw Hook Frida</a></li>
				
				<li><a href="/posts/reading-structs-frida/">Reading Structs Frida</a></li>
				
			</ul>
		</div>
	</div>
</aside>


	<footer>
	<p>&copy; 2021 <a href="https://azurda.github.io"><b>azurda&#39;s blog</b></a>.
	<a href="https://github.com/azurda"><b>Github</b></a>.
	<a href="https://twitter.com/@entdark_"><b>Twitter</b></a>.
	<a href="https://web.libera.chat"><b>Join #azurda-re in libera.chat</b></a>.
	</p>
</footer>

</body>
</html>
